/* Copyright (C) 2013 Yoshi(@gpp256) | This software is distributed under the MIT License. */
glNetViz=function(){this.version=.92;this.textureList=new Array;this._mvMatrixStack=[];this._m=new matIV;this.mMatrix=undefined;this.vpMatrix=undefined};glNetViz.prototype={setMatrixUniforms:function(e,t){if(this.vpMatrix==undefined||this.mMatrix==undefined)return;switch(t){case"use_texture":gl.uniformMatrix4fv(e.pMatrixUniform,false,this.vpMatrix);gl.uniformMatrix4fv(e.mvMatrixUniform,false,this.mMatrix);var n=new Float32Array(9);gl.uniformMatrix3fv(e.nMatrixUniform,false,n);break;default:var r=this._m.identity(this._m.create());var i=this._m.identity(this._m.create());this._m.multiply(this.vpMatrix,this.mMatrix,r);this._m.inverse(this.mMatrix,i);gl.uniformMatrix4fv(e.uniLocation[0],false,r);gl.uniformMatrix4fv(e.uniLocation[1],false,i)}},mvPushMatrix:function(){var e=this._m.create();this._m.set(this.mMatrix,e);this._mvMatrixStack.push(e)},mvPopMatrix:function(){if(this._mvMatrixStack.length==0)throw"Invalid popMatrix!";this.mMatrix=this._mvMatrixStack.pop()},initTextures:function(e){this.createTexture(this.textureList,e+"/pfc_texture01.png",0,256,128);this.createTexture(this.textureList,e+"/sw_texture01.png",1,256,128);this.createTexture(this.textureList,e+"/pc_texture01.png",2,256,128);this.createTexture(this.textureList,e+"/fw_texture01.png",3,256,128);this.createTexture(this.textureList,e+"/earthmap.png",4,256,128);this.createTexture(this.textureList,e+"/font_red.png",5,256,256);this.createTexture(this.textureList,e+"/font_green.png",6,256,256);this.createTexture(this.textureList,e+"/font_blue.png",7,256,256)},addTexture:function(e,t,n,r){if(this.textureList.length>=gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS)throw"Error: failed to add a specified texture.";this.createTexture(this.textureList,e,r,t,n)},createVbo:function(e){var t=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,t);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(e),gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,null);return t},createIbo:function(e){var t=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,t);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Int16Array(e),gl.STATIC_DRAW);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null);return t},putStr:function(e,t,n,r,i,s){gl.enable(gl.BLEND);gl.disable(gl.DEPTH_TEST);gl.blendFunc(gl.SRC_ALPHA,gl.ONE);gl.blendFuncSeparate(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA,gl.ZERO,gl.ONE_MINUS_SRC_ALPHA);this.mvPushMatrix();this._m.translate(this.mMatrix,r,this.mMatrix);this._m.scale(this.mMatrix,[n*i,n*.9,n],this.mMatrix);var o=1.4;var u=(t.length/2-.5)*-o;for(var a=0;a<t.length;a++){this.mvPushMatrix();this._m.translate(this.mMatrix,[u+a*o,0,0],this.mMatrix);this.setMatrixUniforms(e,"use_texture");this.putChar(e,t[a],s);this.mvPopMatrix()}this.mvPopMatrix();gl.disable(gl.BLEND);gl.enable(gl.DEPTH_TEST)},createTruncatedCone:function(e,t,n,r,i,s,o,u){var a=s===undefined?true:s;var f=o===undefined?true:o;var l=(a?2:0)+(f?2:0);var c=u?u:0;var h=[];var p=[];var d=[];var v=[];var m=[];var g=r+1;var y=Math.atan2(e-t,n);var b=Math.cos(y);var w=Math.sin(y);var E=a?-2:0;var S=i+(f?2:0);for(var x=E;x<=S;++x){var T=x/i;var N=n*T;var C;if(x<0){N=0;T=1;C=e}else if(x>i){N=n;T=1;C=t}else{C=e+(t-e)*(x/i)}if(x==-2||x==i+2){C=0;T=0}N-=n/2;for(var k=0;k<g;++k){var L=Math.sin(k*Math.PI*2/r);var A=Math.cos(k*Math.PI*2/r);p=p.concat([L*C,N+c,A*C]);d=d.concat([x<0||x>i?0:L*b,x<0?-1:x>i?1:w,x<0||x>i?0:A*b]);v=v.concat([k/r,1-T])}}for(var x=0;x<i+l;++x){for(var k=0;k<r;++k){m=m.concat([g*(x+0)+0+k,g*(x+0)+1+k,g*(x+1)+1+k],[g*(x+0)+0+k,g*(x+1)+1+k,g*(x+1)+0+k])}}return{vp:p,vn:d,tc:v,vi:m}},createCylinder:function(e,t,n,r,i,s){return this.createTruncatedCone(e,e,t,n,r,i,s)},createArrow:function(e,t,n,r,i){var s=this.createCylinder(10,40,14,8);t["cylinder"]=this.createVbo(s["vp"]);n["cylinder"]=this.createVbo(s["vn"]);g.polygon_num+=s["vi"].length;var o=[];for(var u=0;u<s["vi"].length;u++)o=o.concat([e.r,e.g,e.b,e.a]);r["cylinder"]=this.createVbo(o);i["cylinder"]=this.createIbo(s["vi"]);i["cylinder"].numItems=s["vi"].length;i["cylinder"].drawMethod=gl.TRIANGLES;s=this.createTruncatedCone(18,0,35,14,8,true,true,0);t["cone"]=this.createVbo(s["vp"]);n["cone"]=this.createVbo(s["vn"]);g.polygon_num+=s["vi"].length;o=[];for(var u=0;u<s["vi"].length;u++)o=o.concat([e.r,e.g,e.b,e.a]);r["cone"]=this.createVbo(o);i["cone"]=this.createIbo(s["vi"]);i["cone"].numItems=s["vi"].length;i["cone"].drawMethod=gl.TRIANGLES},degToRad:function(e){return e*Math.PI/180},ipv4ToInt:function(e){var t=0;if(!e.match(/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/))return t;t=parseInt(RegExp.$1)<<24;t+=parseInt(RegExp.$2)<<16;t+=parseInt(RegExp.$3)<<8;t+=parseInt(RegExp.$4);return t},changeArrowColor:function(e,t,n){var r=["cylinder","cone"];for(var i in r){var s=[];for(var o=0;o<n[r[i]].numItems;o++)s=s.concat([e.r,e.g,e.b,e.a]);t[r[i]]=this.createVbo(s)}},setAttribute:function(e,t,n){for(var r in e){gl.bindBuffer(gl.ARRAY_BUFFER,e[r]);gl.enableVertexAttribArray(t[r]);gl.vertexAttribPointer(t[r],n[r],gl.FLOAT,false,0,0)}},initSphere:function(e){var t=[];var n=[];var r=[];var i=[];var s,o,u,a,f;var l,c;var h,p;var d,v;var m,g;for(m=0;m<=e;++m){for(g=0;g<=e;++g){l=m*Math.PI/e;c=g*2*Math.PI/e;h=Math.sin(l);p=Math.sin(c);d=Math.cos(l);v=Math.cos(c);s=v*h;o=d;u=p*h;a=1-g/e;f=m/e;t.push(s);t.push(o);t.push(u);n.push(a);n.push(f);i.push(s);i.push(o);i.push(u)}}var y,b;for(m=0;m<e;++m){for(g=0;g<e;++g){y=m*(e+1)+g;b=y+e+1;r.push(y);r.push(y+1);r.push(b);r.push(b);r.push(y+1);r.push(b+1)}}return{vp:t,tc:n,vn:i,vi:r}},changeObjectsColor:function(e,t,n){for(var r in n){var i=[];for(var s=0;s<e["i"][n[r]].numItems;s++)i=i.concat([t.r,t.g,t.b,t.a]);e["c"][n[r]]=this.createVbo(i)}},generateSphereObject:function(e,t){var n={};var r={};var i={};var s={};var o={};var u=this.initSphere(t);n["sphere"]=this.createVbo(u["vp"]);r["sphere"]=this.createVbo(u["vn"]);o["sphere"]=this.createVbo(u["tc"]);var a=[];for(var f=0;f<u["vi"].length;f++)a=a.concat([e.r,e.g,e.b,e.a]);i["sphere"]=this.createVbo(a);s["sphere"]=this.createIbo(u["vi"]);s["sphere"].numItems=u["vi"].length;s["sphere"].drawMethod=gl.TRIANGLES;g.polygon_num+=u["vi"].length;return{p:n,n:r,c:i,t:o,i:s}},generateSphereObjects:function(e){e.spheres={};var t=this.generateSphereObject({r:1,g:0,b:0,a:1},12);e.spheres["red"]={v:t.p,n:t.n,t:t.t,c:$.extend({},t.c),i:t.i};this.changeObjectsColor(t,{r:0,g:1,b:0,a:1},["sphere"]);e.spheres["green"]={v:t.p,n:t.n,c:$.extend({},t.c),i:t.i};this.changeObjectsColor(t,{r:0,g:0,b:1,a:1},["sphere"]);e.spheres["blue"]={v:t.p,n:t.n,c:$.extend({},t.c),i:t.i}},generateSpheres:function(e,t){var n=arguments[2]!=undefined?arguments[2]:12;var r=t.shift();var i=this.generateSphereObject({r:r.r,g:r.g,b:r.b,a:r.a},n);e.spheres={};e.spheres[r.id]={v:i.p,n:i.n,t:i.t,c:$.extend({},i.c),i:i.i};if(t.length<1)return;for(var s=0;s<t.length;s++){this.changeObjectsColor(i,{r:t[s].r,g:t[s].g,b:t[s].b,a:t[s].a},["sphere"]);e.spheres[t[s].id]={v:i.p,n:i.n,c:$.extend({},i.c),i:i.i}}},putSphere:function(e,t,n,r,i,s){var o=["sphere"];var u=arguments.length==7&&arguments[6]==1?gl.LINE_STRIP:r[o[0]].drawMethod;for(var a=0;a<o.length;a++){this.setAttribute([e[o[a]],t[o[a]],n[o[a]]],i,s);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,r[o[a]]);gl.drawElements(u,r[o[a]].numItems,gl.UNSIGNED_SHORT,0)}},putCylinder:function(e,t,n,r,i,s){var o=["cylinder"];for(var u=0;u<o.length;u++){this.setAttribute([e[o[u]],t[o[u]],n[o[u]]],i,s);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,r[o[u]]);gl.drawElements(r[o[u]].drawMethod,r[o[u]].numItems,gl.UNSIGNED_SHORT,0)}},cubeVertexData:function(){return[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1]},cubeTexCoordData:function(){var e=.0833333;return[0*e,0,0*e,1,1*e,1,1*e,0,1*e,0,2*e,0,2*e,1,1*e,1,8*e,1,8*e,0,4*e,0,4*e,1,1,1,8*e,1,8*e,0,1,0,2*e,1,3*e,1,3*e,0,2*e,0,3*e,1,3*e,0,4*e,0,4*e,1]},cubeNormalData:function(){return[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0]},cubeIndexData:function(){return[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]},initCube:function(){return{vp:this.cubeVertexData(),tc:this.cubeTexCoordData(),vn:this.cubeNormalData(),vi:this.cubeIndexData()}},generateCubeObject:function(e){var t={};var n={};var r={};var i={};var s={};var o=this.initCube();t["cube"]=this.createVbo(o["vp"]);n["cube"]=this.createVbo(o["vn"]);r["cube"]=this.createVbo(o["tc"]);var u=[];for(var a=0;a<o["vi"].length;a++)u=u.concat([e.r,e.g,e.b,e.a]);i["cube"]=this.createVbo(u);s["cube"]=this.createIbo(o["vi"]);s["cube"].numItems=o["vi"].length;s["cube"].drawMethod=gl.TRIANGLES;g.polygon_num+=o["vi"].length;return{p:t,n:n,c:i,t:r,i:s}},generateCubeObjects:function(e){e.cubes={};var t=this.generateCubeObject({r:1,g:0,b:0,a:1});e.cubes["red"]={v:t.p,n:t.n,t:t.t,c:$.extend({},t.c),i:t.i};this.changeObjectsColor(t,{r:0,g:1,b:0,a:1},["cube"]);e.cubes["green"]={v:t.p,n:t.n,c:$.extend({},t.c),i:t.i};this.changeObjectsColor(t,{r:0,g:0,b:1,a:1},["cube"]);e.cubes["blue"]={v:t.p,n:t.n,c:$.extend({},t.c),i:t.i}},generateCubes:function(e,t){var n=t.shift();var r=this.generateCubeObject({r:n.r,g:n.g,b:n.b,a:n.a});e.cubes={};e.cubes[n.id]={v:r.p,n:r.n,t:r.t,c:$.extend({},r.c),i:r.i};if(t.length<1)return;for(var i=0;i<t.length;i++){this.changeObjectsColor(r,{r:t[i].r,g:t[i].g,b:t[i].b,a:t[i].a},["cube"]);e.cubes[t[i].id]={v:r.p,n:r.n,c:$.extend({},r.c),i:r.i}}},putCube:function(e,t,n,r,i,s){var o=["cube"];for(var u=0;u<o.length;u++){this.setAttribute([e[o[u]],t[o[u]],n[o[u]]],i,s);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,r[o[u]]);gl.drawElements(r[o[u]].drawMethod,r[o[u]].numItems,gl.UNSIGNED_SHORT,0)}},rectangleVertexData:function(e){return[-e,-1,0,e,-1,0,e,1,0,-e,1,0]},rectangleNormalData:function(){return[0,0,1,0,0,1,0,0,1,0,0,1]},rectangleTexCoordData:function(e){var t=1;return[e.umin*t,e.vmax,e.umax*t,e.vmax,e.umax*t,e.vmin,e.umin*t,e.vmin]},rectangleIndexData:function(){return[0,1,2,0,2,3]},drawRectangle:function(e,t,n,r,i){var s={red:5,green:6,blue:7};gl.uniform1i(e.useLightingUniform,0);gl.uniform1i(e.samplerUniform,s[i]);if(e.rectangle.TextureCoordBuffer==undefined)e.rectangle.TextureCoordBuffer={};if(e.rectangle.TextureCoordBuffer[t]==undefined){e.rectangle.TextureCoordBuffer[t]=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,e.rectangle.TextureCoordBuffer[t]);var o=this.rectangleTexCoordData(r);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(o),gl.STATIC_DRAW);e.rectangle.TextureCoordBuffer[t].itemSize=2;e.rectangle.TextureCoordBuffer[t].numItems=o/2}gl.bindBuffer(gl.ARRAY_BUFFER,e.rectangle.PositionBuffer);gl.vertexAttribPointer(e.vertexPositionAttribute,e.rectangle.PositionBuffer.itemSize,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,e.rectangle.NormalBuffer);gl.vertexAttribPointer(e.vertexNormalAttribute,e.rectangle.NormalBuffer.itemSize,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,e.rectangle.TextureCoordBuffer[t]);gl.vertexAttribPointer(e.textureCoordAttribute,e.rectangle.TextureCoordBuffer[t].itemSize,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,e.rectangle.IndexBuffer);gl.drawElements(gl.TRIANGLES,e.rectangle.IndexBuffer.numItems,gl.UNSIGNED_SHORT,0);gl.uniform1i(e.useLightingUniform,0)},generateRectangles:function(e){e.rectangle={};e.rectangle.PositionBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,e.rectangle.PositionBuffer);var t=this.rectangleVertexData(.7);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(t),gl.STATIC_DRAW);e.rectangle.PositionBuffer.itemSize=3;e.rectangle.PositionBuffer.numItems=t/3;e.rectangle.NormalBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,e.rectangle.NormalBuffer);var n=this.rectangleNormalData();gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(n),gl.STATIC_DRAW);e.rectangle.NormalBuffer.itemSize=3;e.rectangle.NormalBuffer.numItems=n/3;e.rectangle.IndexBuffer=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,e.rectangle.IndexBuffer);var r=this.rectangleIndexData();gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(r),gl.STATIC_DRAW);e.rectangle.IndexBuffer.itemSize=1;e.rectangle.IndexBuffer.numItems=r.length;g.polygon_num+=2},initRectangle:function(){return{vp:this.rectangleVertexData(1),tc:this.rectangleTexCoordData({umin:0,umax:1,vmin:0,vmax:1}),vn:this.rectangleNormalData(),vi:this.rectangleIndexData()}},generateRectangleFromCL:function(e){var t={};var n={};var r={};var i={};var s={};var o=this.initRectangle();t["rectangle"]=this.createVbo(o["vp"]);n["rectangle"]=this.createVbo(o["vn"]);r["rectangle"]=this.createVbo(o["tc"]);var u=[];for(var a=0;a<o["vi"].length;a++)u=u.concat(e);i["rectangle"]=this.createVbo(u);s["rectangle"]=this.createIbo(o["vi"]);s["rectangle"].numItems=o["vi"].length;s["rectangle"].drawMethod=gl.TRIANGLES;g.polygon_num+=o["vi"].length;return{p:t,n:n,c:i,t:r,i:s}},generateRectanglesFromCL:function(e,t){e.rectangles={};for(var n in t){var r=this.generateRectangleFromCL(t[n]);e.rectangles[n]={v:r.p,n:r.n,c:$.extend({},r.c),t:r.t,i:r.i}}},generateArrows:function(e,t){e.arrows={};var n={};var r={};var i={};var s={};var o=t.shift();this.createArrow(o,n,r,i,s);e.arrows[o.id]={v:n,n:r,c:$.extend({},i),i:s};if(t.length<1)return;for(var u=0;u<t.length;u++){this.changeArrowColor(t[u],i,s);e.arrows[t[u].id]={v:n,n:r,c:$.extend({},i),i:s}}},putArrow:function(e,t,n,r,i,s,o){this._m.translate(this.mMatrix,[0,35/2,0],this.mMatrix);this.setMatrixUniforms(e,"default");var u=["cylinder","cone"];for(var a=0;a<u.length;a++){if(u[a]=="cone"){this._m.translate(this.mMatrix,[0,35,0],this.mMatrix);this.setMatrixUniforms(e,"default")}this.setAttribute([t[u[a]],n[u[a]],r[u[a]]],s,o);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,i[u[a]]);gl.drawElements(i[u[a]].drawMethod,i[u[a]].numItems,gl.UNSIGNED_SHORT,0)}},_putSpheres:function(e,t,n,r,i,s,o){var u={x:0,y:0,z:0};for(var a=0;a<s.length;a++){s[a]+=o/8;u.x=s[a]%100/100*(n[0]-t[0]);u.y=s[a]%100/100*(n[1]-t[1]);u.z=s[a]%100/100*(n[2]-t[2]);this.mvPushMatrix();this._m.translate(this.mMatrix,[t[0]+u.x,t[1]+u.y,t[2]+u.z],this.mMatrix);this._m.scale(this.mMatrix,[.2*i,.2*i,.2*i],this.mMatrix);this.setMatrixUniforms(e,"default");this.putSphere(e.spheres[r]["v"],e.spheres[r]["n"],e.spheres[r]["c"],e.spheres[r]["i"],e.attLocation,[3,3,4]);this.mvPopMatrix()}},_putArrows:function(e,t,n,r,i,s,o,u,a,f,l){if(s==undefined||s.length==0)return;var c={x:0,y:0,z:0};for(var h=0;h<a.length;h++){a[h]+=f/8;c.x=a[h]%100/100*(r[0]-n[0]);c.y=a[h]%100/100*(r[1]-n[1]);c.z=a[h]%100/100*(r[2]-n[2]);this.mvPushMatrix();if(l!=undefined&&l.translate!=undefined)this._m.translate(this.mMatrix,l.translate,this.mMatrix);this._m.translate(this.mMatrix,[n[0]+c.x,n[1]+c.y,n[2]+c.z],this.mMatrix);for(var p=0;p<s.length;p++){this._m.rotate(this.mMatrix,this.degToRad(s[p][0]),[s[p][1],s[p][2],s[p][3]],this.mMatrix)}if(u!=undefined&&t!=undefined){gl.useProgram(t);this.mvPushMatrix();this._m.translate(this.mMatrix,[Math.abs(r[0]-n[0])*-.12,0,0],this.mMatrix);var d=l!=undefined&&l.labelinfo!=undefined?l.labelinfo.size:.05;var v=l!=undefined&&l.labelinfo!=undefined?l.labelinfo.ypos:.1;this.putStr(t,$.sprintf("%d",u),d,[0,v,0],.52,i);this.mvPopMatrix();gl.useProgram(e)}this._m.rotate(this.mMatrix,this.degToRad(90),[0,0,1],this.mMatrix);this._m.scale(this.mMatrix,[.01*o,.01*o,.01*o],this.mMatrix);this._m.translate(this.mMatrix,[0,1.75/2,0],this.mMatrix);this.putArrow(e,e.arrows[i]["v"],e.arrows[i]["n"],e.arrows[i]["c"],e.arrows[i]["i"],e.attLocation,[3,3,4]);this.mvPopMatrix()}},drawFlows:function(e,t,n,r,i){for(var s=0;s<n.length;s++){if(n[s]["rot"]==undefined){this._putSpheres(e,n[s]["start"],n[s]["end"],n[s]["color"],n[s]["size"],r,i)}else{if(n[s]["translate"]==undefined&&n[s]["labelinfo"]==undefined){this._putArrows(e,t,n[s]["start"],n[s]["end"],n[s]["color"],n[s]["rot"],n[s]["size"],n[s]["value"],r,i,undefined)}else{this._putArrows(e,t,n[s]["start"],n[s]["end"],n[s]["color"],n[s]["rot"],n[s]["size"],n[s]["value"],r,i,{translate:n[s]["translate"]==undefined?undefined:n[s]["translate"],labelinfo:n[s]["labelinfo"]==undefined?undefined:n[s]["labelinfo"]})}}}},putRectangle:function(e,t,n,r,i,s){this.setAttribute([e["rectangle"],t["rectangle"],n["rectangle"]],i,s);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,r["rectangle"]);gl.drawElements(r["rectangle"].drawMethod,r["rectangle"].numItems,gl.UNSIGNED_SHORT,0)},putChar:function(e,t,n){var r=256;var i=256;var s=r/13;var o=37.5;var u=[2,44,84,126,164,209];var a={a:[.5+s*0,u[0]],b:[.5+s*1,u[0]],c:[.5+s*2,u[0]],d:[.5+s*3,u[0]],e:[.5+s*4,u[0]],f:[.5+s*5,u[0]],g:[.5+s*6,u[0]],h:[.5+s*7,u[0]],i:[.5+s*8,u[0]],j:[.5+s*9,u[0]],k:[.5+s*10,u[0]],l:[.5+s*11,u[0]],m:[.5+s*12,u[0]],n:[.5+s*0,u[1]],o:[.5+s*1,u[1]],p:[.5+s*2,u[1]],q:[.5+s*3,u[1]],r:[.5+s*4,u[1]],s:[.5+s*5,u[1]],t:[.5+s*6,u[1]],u:[.5+s*7,u[1]],v:[.5+s*8,u[1]],w:[.5+s*9,u[1]],x:[.5+s*10,u[1]],y:[.5+s*11,u[1]],z:[.5+s*12,u[1]],A:[-.1+s*0,u[2]],B:[-.1+s*1,u[2]],C:[-.1+s*2,u[2]],D:[-.1+s*3,u[2]],E:[-.1+s*4,u[2]],F:[-.1+s*5,u[2]],G:[-.1+s*6,u[2]],H:[-.1+s*7,u[2]],I:[-.1+s*8,u[2]],J:[-.1+s*9,u[2]],K:[-.1+s*10,u[2]],L:[-.1+s*11,u[2]],M:[-.1+s*12,u[2]],N:[-0+s*0,u[3]],O:[-0+s*1,u[3]],P:[-0+s*2,u[3]],Q:[-0+s*3,u[3]],R:[-0+s*4,u[3]],S:[-0+s*5,u[3]],T:[-0+s*6,u[3]],U:[-0+s*7,u[3]],V:[-0+s*8,u[3]],W:[-0+s*9,u[3]],X:[-0+s*10,u[3]],Y:[-0+s*11,u[3]],Z:[-0+s*12,u[3]],":":[.1+s*0,u[4]],"/":[.1+s*1,u[4]],"\\":[.1+s*2,u[4]],"<":[.1+s*3,u[4]],">":[.1+s*4,u[4]],".":[.1+s*5,u[4]],",":[.1+s*6,u[4]],"?":[.1+s*7,u[4]],"[":[.1+s*8,u[4]],"]":[.1+s*9,u[4]],"!":[.1+s*10,u[4]],"-":[.1+s*11,u[4]],"=":[.1+s*12,u[4]],0:[s*0,u[5]],1:[s*1,u[5]],2:[s*2,u[5]],3:[s*3,u[5]],4:[s*4,u[5]],5:[s*5,u[5]],6:[s*6,u[5]],7:[s*7,u[5]],8:[s*8,u[5]],9:[s*9,u[5]]};if(a[t]==undefined){a[t]=[s*10,u[5]]}this.drawRectangle(e,t,[0,0,0],{umin:(a[t][0]+1)/r,umax:(a[t][0]+s-1)/r,vmin:a[t][1]/i,vmax:(a[t][1]+o)/i},n)},generateCylinderObject:function(e){var t={};var n={};var r={};var i={};var s=this.createCylinder(.04,3,14,8);t["cylinder"]=this.createVbo(s["vp"]);n["cylinder"]=this.createVbo(s["vn"]);var o=[];for(var u=0;u<s["vi"].length;u++)o=o.concat([e.r,e.g,e.b,e.a]);r["cylinder"]=this.createVbo(o);i["cylinder"]=this.createIbo(s["vi"]);i["cylinder"].numItems=s["vi"].length;i["cylinder"].drawMethod=gl.TRIANGLES;return{p:t,n:n,c:r,i:i}},generateCylinderObjects:function(e){e.cylinders={};var t=this.generateCylinderObject({r:1,g:1,b:0,a:1});e.cylinders["yellow"]={v:t.p,n:t.n,c:$.extend({},t.c),i:t.i};this.changeObjectsColor(t,{r:.1,g:.1,b:.1,a:1},["cylinder"]);e.cylinders["gray"]={v:t.p,n:t.n,c:$.extend({},t.c),i:t.i}},generateCylinders:function(e,t){var n=t.shift();var r=this.generateCylinderObject({r:n.r,g:n.g,b:n.b,a:n.a});e.cylinders={};e.cylinders[n.id]={v:r.p,n:r.n,c:$.extend({},r.c),i:r.i};if(t.length<1)return;for(var i=0;i<t.length;i++){this.changeObjectsColor(r,{r:t[i].r,g:t[i].g,b:t[i].b,a:t[i].a},["cylinder"]);e.cylinders[t[i].id]={v:r.p,n:r.n,c:$.extend({},r.c),i:r.i}}},generateConeObject:function(e){var t={};var n={};var r={};var i={};var s=this.createTruncatedCone(.4,0,1.2,4,4,true,true,1.5);t["cone"]=this.createVbo(s["vp"]);n["cone"]=this.createVbo(s["vn"]);var o=[];for(var u=0;u<s["vi"].length;u++)o=o.concat([e.r,e.g,e.b,e.a]);r["cone"]=this.createVbo(o);i["cone"]=this.createIbo(s["vi"]);i["cone"].numItems=s["vi"].length;i["cone"].drawMethod=gl.TRIANGLES;return{p:t,n:n,c:r,i:i}},generateConeObjects:function(e){e.cones={};var t=this.generateConeObject({r:1,g:1,b:0,a:1});e.cones["yellow"]={v:t.p,n:t.n,c:$.extend({},t.c),i:t.i}},generateCones:function(e,t){var n=t.shift();var r=this.generateConeObject({r:n.r,g:n.g,b:n.b,a:n.a});e.cones={};e.cones[n.id]={v:r.p,n:r.n,c:$.extend({},r.c),i:r.i};if(t.length<1)return;for(var i=0;i<t.length;i++){this.changeObjectsColor(r,{r:t[i].r,g:t[i].g,b:t[i].b,a:t[i].a},["cone"]);e.cones[t[i].id]={v:r.p,n:r.n,c:$.extend({},r.c),i:r.i}}},putCone:function(e,t,n,r,i,s){var o=["cone"];for(var u=0;u<o.length;u++){this.setAttribute([e[o[u]],t[o[u]],n[o[u]]],i,s);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,r[o[u]]);gl.drawElements(r[o[u]].drawMethod,r[o[u]].numItems,gl.UNSIGNED_SHORT,0)}},initUniformLocation:function(e,t){gl.useProgram(e);switch(t){case"use_texture":e.vertexPositionAttribute=gl.getAttribLocation(e,"aVertexPosition");gl.enableVertexAttribArray(e.vertexPositionAttribute);e.vertexNormalAttribute=gl.getAttribLocation(e,"aVertexNormal");gl.enableVertexAttribArray(e.vertexNormalAttribute);e.textureCoordAttribute=gl.getAttribLocation(e,"aTextureCoord");gl.enableVertexAttribArray(e.textureCoordAttribute);e.mvMatrixUniform=gl.getUniformLocation(e,"uMVMatrix");e.pMatrixUniform=gl.getUniformLocation(e,"uPMatrix");e.nMatrixUniform=gl.getUniformLocation(e,"uNMatrix");e.ambientColorUniform=gl.getUniformLocation(e,"uAmbientColor");e.lightingDirectionUniform=gl.getUniformLocation(e,"uLightingDirection");e.directionalColorUniform=gl.getUniformLocation(e,"uDirectionalColor");e.useLightingUniform=gl.getUniformLocation(e,"uUseLighting");e.alphaUniform=gl.getUniformLocation(e,"uAlpha");e.samplerUniform=gl.getUniformLocation(e,"uSampler");e.useTextureUniform=gl.getUniformLocation(e,"uUseTexture");e.useArrowUniform=gl.getUniformLocation(e,"uUseArrow");gl.uniform3f(e.ambientColorUniform,.8,.8,.8);var n=new Float32Array(3);n[0]=0;n[0]=0;n[0]=-1;gl.uniform3fv(e.lightingDirectionUniform,n);gl.uniform3f(e.directionalColorUniform,.6,.6,.6);gl.uniform1i(e.useLightingUniform,1);gl.uniform1f(e.alphaUniform,1);gl.uniform1i(e.samplerUniform,0);gl.uniform1i(e.useTextureUniform,1);gl.uniform1i(e.useArrowUniform,0);break;default:e.uniLocation=new Array;e.attLocation=new Array;e.attStride=new Array;e.uniLocation[0]=gl.getUniformLocation(e,"mvpMatrix");e.uniLocation[1]=gl.getUniformLocation(e,"invMatrix");e.uniLocation[2]=gl.getUniformLocation(e,"lightDirection");e.uniLocation[3]=gl.getUniformLocation(e,"eyeDirection");e.uniLocation[4]=gl.getUniformLocation(e,"ambientColor");e.attLocation[0]=gl.getAttribLocation(e,"position");e.attLocation[1]=gl.getAttribLocation(e,"normal");e.attLocation[2]=gl.getAttribLocation(e,"color");e.attStride[0]=3;e.attStride[1]=3;e.attStride[2]=4;var r=[-.5,.5,.5];var i=[0,0,25];var s=[.2,.2,.2,1];gl.uniform3fv(e.uniLocation[2],r);gl.uniform3fv(e.uniLocation[3],i);gl.uniform4fv(e.uniLocation[4],s)}},createTexture:function(e,t,n,r,i){var s=new Image;s.onload=function(){var t=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,t);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,s);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.generateMipmap(gl.TEXTURE_2D);gl.bindTexture(gl.TEXTURE_2D,null);e[n]=t};s.src=t;s.width=r;s.height=i},_multiplyVec3:function(e,t,n){var r=t[0],i=t[1];t=t[2];n[0]=e[0]*r+e[4]*i+e[8]*t+e[12];n[1]=e[1]*r+e[5]*i+e[9]*t+e[13];n[2]=e[2]*r+e[6]*i+e[10]*t+e[14]},intersect:function(e,t){var n=1e-7;var r=g.scale/30;var i=r*r*.1;pos=[0,0,0];this._multiplyVec3(this.mMatrix,[0,0,0],pos);var s=[0,0,0];s[0]=pos[0]-g.eye.x;s[1]=pos[1]-g.eye.y;s[2]=pos[2]-g.eye.z;var o=[0,0,-1];var u=o[0]*s[0]+o[1]*s[1]+o[2]*s[2];var a=u*u-(s[0]*s[0]+s[1]*s[1]+s[2]*s[2])+i;a=a>0?Math.sqrt(a):1e31;a=u-a>n?u-a:u+a;if(a>=n&&a<t.tmin){t.touch_flag=e;t.tmin=a}return t},touchHandler:function(e){var t=e.changedTouches,n=t[0],r="";switch(e.type){case"touchstart":r="mousedown";break;case"touchmove":r="mousemove";break;case"touchend":r="mouseup";break;default:return}var i=document.createEvent("MouseEvent");i.initMouseEvent(r,true,true,window,1,n.screenX,n.screenY,n.clientX,n.clientY,false,false,false,false,0,null);n.target.dispatchEvent(i);e.preventDefault()},initEvent:function(){document.addEventListener("touchstart",this.touchHandler,true);document.addEventListener("touchmove",this.touchHandler,true);document.addEventListener("touchend",this.touchHandler,true);document.addEventListener("touchcancel",this.touchHandler,true)},getVertexShader:function(e){if(e==undefined)e="default";var t={"default":""+"attribute vec3 position;\n"+"attribute vec3 normal;\n"+"attribute vec4 color;\n"+"uniform   mat4 mvpMatrix;\n"+"uniform   mat4 invMatrix;\n"+"uniform   vec3 lightDirection;\n"+"uniform   vec3 eyeDirection;\n"+"uniform   vec4 ambientColor;\n"+"varying   vec4 vColor;\n"+"varying   vec3 vNormal;\n"+"void main(void){\n"+"  vec3  invLight = normalize(invMatrix * vec4(lightDirection, 0.0)).xyz;\n"+"  vec3  invEye   = normalize(invMatrix * vec4(eyeDirection, 0.0)).xyz;\n"+"  vec3  halfLE   = normalize(invLight + invEye);\n"+"  float diffuse  = clamp(dot(normal, invLight), 0.1, 1.0);\n"+"	float specular = pow(clamp(dot(normal, halfLE), 0.0, 1.0), 50.0);\n"+"	vec4  light    = color * vec4(vec3(diffuse), 1.0) + vec4(vec3(specular), 1.0);\n"+"	vColor         = light + ambientColor;\n"+"  vNormal        = normal;\n"+"  gl_Position    = mvpMatrix * vec4(position, 1.0);\n"+"}",use_texture:""+"attribute vec3 aVertexPosition;\n"+"attribute vec3 aVertexNormal;\n"+"attribute vec2 aTextureCoord;\n"+"uniform mat4 uMVMatrix;\n"+"uniform mat4 uPMatrix;\n"+"uniform mat3 uNMatrix;\n"+"uniform vec3 uAmbientColor;\n"+"uniform vec3 uLightingDirection;\n"+"uniform vec3 uDirectionalColor;\n"+"uniform bool uUseLighting;\n"+"varying vec2 vTextureCoord;\n"+"varying vec3 vLightWeighting;\n"+"void main(void) {\n"+"  gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);\n"+"  vTextureCoord = aTextureCoord;\n"+"  if (!uUseLighting) {\n"+"    vLightWeighting = vec3(1.0, 1.0, 1.0);\n"+"  } else {\n"+"    vec3 transformedNormal = uNMatrix * aVertexNormal;\n"+"    float directionalLightWeighting = max(dot(transformedNormal, uLightingDirection), 0.0);\n"+"    vLightWeighting = uAmbientColor + uDirectionalColor * directionalLightWeighting;\n"+"  }\n"+"}"};return t[e]==undefined?t["default"]:t[e]},getFragmentShader:function(e){if(e==undefined)e="default";var t={"default":""+"precision mediump float;\n"+"uniform mat4 invMatrix;\n"+"uniform vec3 lightDirection;\n"+"uniform vec3 eyeDirection;\n"+"uniform vec4 ambientColor;\n"+"varying vec3 vNormal;\n"+"varying vec4 vColor;\n"+"void main(void){\n"+"    vec3  invLight  = normalize(invMatrix * vec4(lightDirection, 0.0)).xyz;\n"+"    vec3  invEye    = normalize(invMatrix * vec4(eyeDirection, 0.0)).xyz;\n"+"    vec3  halfLE    = normalize(invLight + invEye);\n"+"    float diffuse   = clamp(dot(vNormal, invLight), 0.0, 1.0);\n"+"    float specular  = pow(clamp(dot(vNormal, halfLE), 0.0, 1.0), 50.0);\n"+"    vec4  destColor = vColor * vec4(vec3(diffuse), 1.0) + vec4(vec3(specular), 1.0) + ambientColor;\n"+"    gl_FragColor = destColor;\n"+"}",use_texture:""+"#ifdef GL_ES\n"+"precision mediump float;\n"+"#endif\n"+"varying vec2 vTextureCoord;\n"+"varying vec3 vLightWeighting;\n"+"uniform float uAlpha;\n"+"uniform sampler2D uSampler;\n"+"uniform bool uUseTexture;\n"+"uniform bool uUseArrow;\n"+"void main(void) {\n"+"if (!uUseTexture) {\n"+"    if (uUseArrow) {\n"+"        gl_FragColor = vec4(0.1, 0.1, 0.1, 0.6);\n"+"	} else {   \n"+"        gl_FragColor = vec4(1.0, 1.0, 0.0, 0.6);\n"+"	}\n"+"} else {\n"+"    vec4 textureColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n"+"    gl_FragColor = vec4(textureColor.rgb * vLightWeighting, textureColor.a * uAlpha);\n"+"}\n"+"}"};return t[e]==undefined?t["default"]:t[e]},createShader:function(e,t,n){var r;var i="";switch(e){case"script":var s=document.getElementById(n);if(!s){return}i=s.text;break;case"raw":i=n;break;default:return}switch(t){case"x-shader/x-vertex":r=gl.createShader(gl.VERTEX_SHADER);break;case"x-shader/x-fragment":r=gl.createShader(gl.FRAGMENT_SHADER);break;default:return}gl.shaderSource(r,i);gl.compileShader(r);if(gl.getShaderParameter(r,gl.COMPILE_STATUS)){return r}else{alert(gl.getShaderInfoLog(r))}},createProgram:function(e,t){var n=gl.createProgram();gl.attachShader(n,e);gl.attachShader(n,t);gl.linkProgram(n);if(gl.getProgramParameter(n,gl.LINK_STATUS)){gl.useProgram(n);return n}else{alert(gl.getProgramInfoLog(n))}},generateColorTable:function(e){var t=255;var n=255;var r=255;var i=new Array(200);var s;switch(e){case 0:for(s=201;s>=2;s--){if(s<=200)t=Math.round(t-1.275);i[s-2]=[t,t,t]}break;default:for(s=2;s<=201;s++){if(s<=50){t=0;n=Math.floor(s/50*255);r=255}else if(s>50&&s<=100){t=0;n=255;r=Math.floor((1-(s-50)/50)*255)}else if(s>100&&s<=150){t=Math.round((s-100)/50*255);n=255;r=0}else if(s>150){t=255;n=Math.round((1-(s-150)/51)*255);r=0}i[s-2]=[t,n,r]}break}return i},browserLanguage:function(){try{return(navigator.browserLanguage||navigator.language||navigator.userLanguage).substr(0,2)}catch(e){return undefined}}};
